generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Proprietaire {
  id                   String          @id @default(uuid())
  nom_complet          String
  telephone            String          @unique
  email                String?         @unique
  adresse              String?
  mot_de_passe         String
  whatsapp             String?
  ville                String?
  type_proprietaire    TypeProprietaire @default(PARTICULIER)
  raison_sociale       String?
  profil_complet       Boolean         @default(false)
  taux_completude_profil Int           @default(0)
  statut               StatutProprietaire @default(ACTIF)
  role                 String          @default("PROPRIETAIRE")
  date_creation        DateTime        @default(now())
  date_modification    DateTime        @updatedAt

  // Relations pour l'authentification
  refreshTokens        RefreshToken[]
  passwordResets       PasswordReset[]
  biens                Bien[]

  @@map("proprietaires")
}

model RefreshToken {
  id          String      @id @default(uuid())
  token       String      @unique
  proprietaireId String
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime    @default(now())
  userAgent   String?
  ipAddress   String?

  proprietaire Proprietaire @relation(fields: [proprietaireId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([proprietaireId])
  @@map("refresh_tokens")
}

model PasswordReset {
  id            String          @id @default(uuid())
  code          String
  type          ResetType       @default(EMAIL)
  proprietaireId String?
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime        @default(now())

  proprietaire  Proprietaire?    @relation(fields: [proprietaireId], references: [id], onDelete: SetNull)

  @@index([code])
  @@map("password_resets")
}

enum TypeProprietaire {
  PARTICULIER
  ENTREPRISE
}

enum StatutProprietaire {
  ACTIF
  INACTIF
  SUSPENDU
}

enum ResetType {
  EMAIL
  SMS
}

model Pays {
  id          String   @id @default(uuid())
  nom         String   @unique
  code        String?  @unique // Code ISO du pays (ex: SN pour Sénégal)
  date_creation DateTime @default(now())
  date_modification DateTime @updatedAt
  
  villes      Ville[]
  
  @@map("pays")
}

model Ville {
  id          String   @id @default(uuid())
  nom         String
  paysId      String
  date_creation DateTime @default(now())
  date_modification DateTime @updatedAt
  
  pays        Pays     @relation(fields: [paysId], references: [id], onDelete: Cascade)
  biens       Bien[]
  
  @@unique([nom, paysId]) // Une ville est unique dans un pays
  @@index([paysId])
  @@map("villes")
}

// Modèle pour les biens immobiliers
model Bien {
  id                String   @id @default(uuid())
  titre             String
  type              TypeBien
  prix              Decimal  @db.Decimal(15, 2) // Prix plus précis pour les montants financiers
  statut            StatutBien @default(DISPONIBLE)
  modeLocation      ModeLocation?
  description       String?
  surface           Float?
  surfaceHabitable  Float?  // Surface habitable en m²
  surfaceTerrain    Float?  // Surface du terrain en m² (pour villas/terrains)
  nbPieces          Int?    // Nombre total de pièces
  chambres          Int?
  sallesDeBain      Int?
  etage             Int?     // Numéro d'étage
  numeroPorte       String?  // Numéro de porte/appartement
  adresse           String
  quartier          String?
  villeId           String?
  
  // Disponibilité
  disponibleALocation Boolean @default(true)
  dateDisponibilite  DateTime? // Date à partir de laquelle le bien est disponible
  
  // Coordonnées GPS (calculées automatiquement via géocodage)
  latitude          Float?
  longitude         Float?
  
  // Images et documents
  imageCouverture   String?
  images            String?  // JSON array d'URLs
  documents         String?  // JSON array de documents
  urlVisiteVirtuelle String?
  
  // Caractéristiques supplémentaires
  caracteristiques   String?  // JSON array de caractéristiques (ascenseur, garage, balcon, etc.)
  
  // Métadonnées
  dateCreation      DateTime @default(now())
  dateModification  DateTime @updatedAt
  proprietaireId    String
  
  // Relations
  ville             Ville?          @relation(fields: [villeId], references: [id], onDelete: SetNull)
  proprietaire      Proprietaire    @relation(fields: [proprietaireId], references: [id], onDelete: Cascade)
  etablissements    EtablissementProche[]
  
  @@index([villeId])
  @@index([proprietaireId])
  @@index([type])
  @@index([statut])
  @@index([dateDisponibilite])
  @@map("biens")
}

// Types de biens immobiliers
enum TypeBien {
  APPARTEMENT
  VILLA
  MAISON
  STUDIO
  CHAMBRE
  BUREAU
  LOCAL_COMMERCIAL
  TERRAIN
  IMMEUBLE
}

// Statuts des biens
enum StatutBien {
  DISPONIBLE
  LOUE
  VENDU
  INDISPONIBLE
  EN_MAINTENANCE
}

// Modes de location
enum ModeLocation {
  JOURNALIER
  MENSUEL
  ANNUEL
  SAISONNIER
}

// Établissements proches d'un bien immobilier
model EtablissementProche {
  id              String   @id @default(uuid())
  bienId          String
  
  // Catégorie et type d'établissement
  categorie       CategorieEtablissement
  type            TypeEtablissement
  
  // Informations sur l'établissement
  nom             String
  adresse         String?
  distanceKm      Float    // Distance en kilomètres
  dureeMinutes    Int?     // Durée de trajet estimée en minutes
  
  // Coordonnées GPS de l'établissement
  latitude        Float?
  longitude       Float?
  
  // Métadonnées
  dateCreation    DateTime @default(now())
  dateModification DateTime @updatedAt
  
  // Relation
  bien            Bien     @relation(fields: [bienId], references: [id], onDelete: Cascade)
  
  @@unique([bienId, type, nom]) // Éviter les doublons
  @@index([bienId])
  @@index([categorie])
  @@index([type])
  @@map("etablissements_proches")
}

// Catégories d'établissements
enum CategorieEtablissement {
  SANTE
  EDUCATION
  COMMERCE_ALIMENTATION
  LIEUX_CULTE
  SECURITE_SERVICES_PUBLICS
  TRANSPORT
  LOISIRS_QUALITE_VIE
}

// Types d'établissements
enum TypeEtablissement {
  // Santé
  HOPITAL
  PHARMACIE
  
  // Éducation
  ECOLE_MATERNELLE
  ECOLE_PRIMAIRE
  COLLEGE
  LYCEE
  UNIVERSITE
  CENTRE_FORMATION
  
  // Commerce & Alimentation
  SUPERMARCHE
  BOUTIQUE_QUARTIER
  MARCHE
  CENTRE_COMMERCIAL
  BOULANGERIE
  
  // Lieux de culte
  MOSQUEE
  EGLISE
  
  // Sécurité & Services publics
  COMMISSARIAT_GENDARMERIE
  CASERNE_POMPIERS
  MAIRIE
  
  // Transport
  ARRET_BUS
  GARE
  STATION_BRT
  ROUTE_PRINCIPALE
  
  // Loisirs & Qualité de vie
  SALLE_SPORT
  PARC
  RESTAURANT
  PLAGE
  TERRAIN_SPORT
}
