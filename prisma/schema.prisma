generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Proprietaire {
  id                   String          @id @default(uuid())
  nom_complet          String
  telephone            String          @unique
  email                String?         @unique
  adresse              String?
  mot_de_passe         String
  whatsapp             String?
  ville                String?
  type_proprietaire    TypeProprietaire @default(PARTICULIER)
  raison_sociale       String?
  profil_complet       Boolean         @default(false)
  taux_completude_profil Int           @default(0)
  statut               StatutProprietaire @default(ACTIF)
  role                 String          @default("PROPRIETAIRE")
  date_creation        DateTime        @default(now())
  date_modification    DateTime        @updatedAt

  // Relations pour l'authentification
  refreshTokens        RefreshToken[]
  passwordResets       PasswordReset[]

  @@map("proprietaires")
}

model RefreshToken {
  id          String      @id @default(uuid())
  token       String      @unique
  proprietaireId String
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime    @default(now())
  userAgent   String?
  ipAddress   String?

  proprietaire Proprietaire @relation(fields: [proprietaireId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([proprietaireId])
  @@map("refresh_tokens")
}

model PasswordReset {
  id            String          @id @default(uuid())
  code          String
  type          ResetType       @default(EMAIL)
  proprietaireId String?
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime        @default(now())

  proprietaire  Proprietaire?    @relation(fields: [proprietaireId], references: [id], onDelete: SetNull)

  @@index([code])
  @@map("password_resets")
}

enum TypeProprietaire {
  PARTICULIER
  ENTREPRISE
}

enum StatutProprietaire {
  ACTIF
  INACTIF
  SUSPENDU
}

enum ResetType {
  EMAIL
  SMS
}

model Pays {
  id          String   @id @default(uuid())
  nom         String   @unique
  code        String?  @unique // Code ISO du pays (ex: SN pour Sénégal)
  date_creation DateTime @default(now())
  date_modification DateTime @updatedAt
  
  villes      Ville[]
  
  @@map("pays")
}

model Ville {
  id          String   @id @default(uuid())
  nom         String
  paysId      String
  date_creation DateTime @default(now())
  date_modification DateTime @updatedAt
  
  pays        Pays     @relation(fields: [paysId], references: [id], onDelete: Cascade)
  
  @@unique([nom, paysId]) // Une ville est unique dans un pays
  @@index([paysId])
  @@map("villes")
}
