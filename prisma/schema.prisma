generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// MODÈLES GÉOGRAPHIQUES
// ============================================================

model Pays {
  id        String   @id @default(uuid())
  nom       String   @unique
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  villes Ville[]
}

model Ville {
  id        String   @id @default(uuid())
  nom       String
  paysId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pays Pays @relation(fields: [paysId], references: [id])

  @@unique([nom, paysId])
}

// ============================================================
// BIENS IMMOBILIERS
// ============================================================

model TypeLogement {
  id        String   @id @default(uuid())
  nom       String   @unique
  slug      String   @unique
  image     String?
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  biens Bien[]

  @@index([slug])
}

model TypeTransaction {
  id        String   @id @default(uuid())
  nom       String   @unique
  slug      String   @unique
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  biens Bien[]

  @@index([slug])
}

model StatutBien {
  id        String   @id @default(uuid())
  nom       String   @unique
  slug      String   @unique
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  biens Bien[]

  @@index([slug])
}

// ============================================================
// CATÉGORIES MEUBLÉ / ÉQUIPEMENT
// ============================================================

model CategorieMeuble {
  id        String   @id @default(uuid())
  nom       String   @unique
  slug      String   @unique
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meubles Meuble[]

  @@index([slug])
}

model CategorieEquipement {
  id        String   @id @default(uuid())
  nom       String   @unique
  slug      String   @unique
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  equipements Equipement[]

  @@index([slug])
}

model Meuble {
  id          String   @id @default(uuid())
  nom         String
  categorieId String
  actif       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categorie CategorieMeuble @relation(fields: [categorieId], references: [id])
  biens     BienMeuble[]

  @@unique([nom, categorieId])
  @@index([categorieId])
}

model Equipement {
  id          String   @id @default(uuid())
  nom         String
  categorieId String
  actif       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categorie CategorieEquipement @relation(fields: [categorieId], references: [id])
  biens     BienEquipement[]

  @@unique([nom, categorieId])
  @@index([categorieId])
}

// ============================================================
// BIENS
// ============================================================

enum StatutAnnonce {
  BROUILLON
  EN_ATTENTE
  PUBLIE
  REJETE
}

model Bien {
  id                String    @id @default(uuid())
  titre             String?
  description       String?
  typeLogementId    String?
  typeTransactionId String?
  statutBienId      String?
  proprietaireId    String

  // Localisation
  pays              String?
  region            String?
  ville             String?
  quartier          String?
  adresse           String?
  pointRepere       String?
  latitude          Float?
  longitude         Float?

  // Caractéristiques
  surface           Float?
  surfaceParcelle   Float?
  nbChambres        Int?
  nbSdb             Int?
  nbSalons          Int?
  nbCuisines        Int?
  etage             Int?
  nbEtages          Int?
  nbAppartements    Int?
  nbPieces          Int?
  nbWc              Int?
  typeTerrain       String?
  cloture           Boolean   @default(false)
  typeBureau        String?
  rideauMetallique  Boolean   @default(false)

  // Options
  meuble            Boolean   @default(false)
  fumeurs           Boolean   @default(false)
  animaux           Boolean   @default(false)
  parking           Boolean   @default(false)
  ascenseur         Boolean   @default(false)

  // Prix
  prix              Float?
  frequencePaiement String?
  chargesIncluses   Boolean   @default(false)
  caution           Float?
  disponibleLe      DateTime?

  // Médias
  photos            String[]

  // État & Publication
  actif             Boolean       @default(true)
  statutAnnonce     StatutAnnonce @default(BROUILLON)
  noteAdmin         String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  typeLogement    TypeLogement?    @relation(fields: [typeLogementId], references: [id])
  typeTransaction TypeTransaction? @relation(fields: [typeTransactionId], references: [id])
  statutBien      StatutBien?      @relation(fields: [statutBienId], references: [id])
  proprietaire    Proprietaire     @relation(fields: [proprietaireId], references: [id])

  equipements    BienEquipement[]
  meubles        BienMeuble[]
  etablissements Etablissement[]

  @@index([proprietaireId])
  @@index([typeLogementId])
  @@index([typeTransactionId])
  @@index([statutBienId])
  @@index([statutAnnonce])
}

model BienEquipement {
  bienId       String
  equipementId String

  bien       Bien       @relation(fields: [bienId], references: [id], onDelete: Cascade)
  equipement Equipement @relation(fields: [equipementId], references: [id])

  @@unique([bienId, equipementId])
}

model BienMeuble {
  bienId   String
  meubleId String
  quantite Int    @default(1)

  bien   Bien   @relation(fields: [bienId], references: [id], onDelete: Cascade)
  meuble Meuble @relation(fields: [meubleId], references: [id])

  @@unique([bienId, meubleId])
}

// ============================================================
// ÉTABLISSEMENTS PROCHES
// ============================================================

model Etablissement {
  id        String   @id @default(uuid())
  bienId    String
  type      String
  nom       String?
  latitude  Float
  longitude Float
  distance  Float?
  createdAt DateTime @default(now())

  bien Bien @relation(fields: [bienId], references: [id], onDelete: Cascade)

  @@index([bienId])
  @@index([type])
}

// ============================================================
// AUTHENTIFICATION PROPRIÉTAIRES
// ============================================================

model Proprietaire {
  id        String   @id @default(uuid())
  prenom    String
  nom       String
  sexe      String?
  telephone String   @unique
  email     String?  @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens ProprietaireRefreshToken[]
  biens         Bien[]
}

model ProprietaireRefreshToken {
  id             String    @id @default(uuid())
  proprietaireId String
  tokenHash      String    @unique
  expiresAt      DateTime
  revokedAt      DateTime?
  createdAt      DateTime  @default(now())

  proprietaire Proprietaire @relation(fields: [proprietaireId], references: [id], onDelete: Cascade)

  @@index([proprietaireId])
  @@index([tokenHash])
}

// ============================================================
// AUTHENTIFICATION ADMIN
// ============================================================

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String    @id @default(uuid())
  adminId   String
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([tokenHash])
}
